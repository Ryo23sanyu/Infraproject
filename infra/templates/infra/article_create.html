{% extends "base.html" %}

{% block title %}案件作成{% endblock title %}

{% block content %}
  <form method='POST' novalidate>
    {% csrf_token %}
    <div>
      <label for="{{ form.案件名.id_for_label }}">案件名:</label>
      {{ form.案件名 }}
    </div>
    <div>
      <label for="{{ form.対象数.id_for_label }}">対象数:</label>
      {{ form.対象数 }}
    </div>
    <div>
      <label for="{{ form.担当者名.id_for_label }}">担当者名:</label>
      {{ form.担当者名 }}
    </div>
    <div>
      <label for="{{ form.その他.id_for_label }}">その他:</label>
      {{ form.その他 }}
    </div>
    <div>
      <label for="id_file_path">ファイルパス:</label>
      <input id="id_file_path" name="ファイルパス" type="text" value="{{ form.initial.ファイルパス }}" readonly />
      <button type="button" onclick="toggleFileTree()">Select File</button>
    </div>
    <div>
      <input type='submit' value='作成'>
    </div>

    <div id="file-tree-container" style="display: none;">
      <tbody id="file-tree">
          <button type="button" class="toggle-btn" onclick="toggleDirectory(this, '{{ root_dir }}')">+</button> Home Directory
      </tbody>
    </div>

</form>

<script>
  function toggleFileTree() {
    const container = document.getElementById('file-tree-container');
    container.style.display = container.style.display === 'none' ? 'block' : 'none';
}

function toggleDirectory(element, path) {
    const nextElement = element.parentNode.querySelector('ul');
    if (nextElement) {
        // Already expanded, so collapse it
        if (nextElement.style.display === 'none') {
            nextElement.style.display = 'block';
            element.innerHTML = '-';
        } else {
            nextElement.style.display = 'none';
            element.innerHTML = '+';
        }
    } else {
        // Not expanded, so expand it
        fetch("{% url 'get-subdirectories' %}?path=" + encodeURIComponent(path))
            .then(response => response.json())
            .then(data => {
                const ul = document.createElement('ul');
                data.directories.forEach(subDir => {
                    const li = document.createElement('li');
                    li.innerHTML = `<button class="toggle-btn" onclick="toggleDirectory(this, '${subDir}')">+</button> ${subDir}`;
                    ul.appendChild(li);
                });
                data.files.forEach(file => {
                    const li = document.createElement('li');
                    li.innerHTML = file;
                    li.onclick = function () { selectFile(file); };
                    ul.appendChild(li);
                });
                element.innerHTML = '-';
                element.parentNode.appendChild(ul);
            });
    }
}

function selectFile(filePath) {
    document.getElementById('id_file_path').value = filePath;
    document.cookie = "selected_file=" + filePath + "; path=/";
    alert('Selected file: ' + filePath); // 選択したファイルパスを表示
}

function submitSelection() {
    window.location.href = "{% url 'create-article' %}";
}
</script>

{% endblock content %}